<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-journal-check"></i> Loan Management</h2>
        <button type="button" class="btn btn-success" (click)="openCreateModal()">
          <i class="bi bi-plus-circle"></i> Add New Loan
        </button>
      </div>

      <!-- Messages -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="clearMessages()"></button>
      </div>

      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="clearMessages()"></button>
      </div>

      <!-- Loans Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">All Loans ({{ totalItems }} total)</h5>
        </div>
        <div class="card-body">
          <!-- Loading Spinner -->
          <div *ngIf="loading" class="text-center p-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading loans...</p>
          </div>

          <!-- Loans Table -->
          <div *ngIf="!loading" class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Book</th>
                  <th>Lender</th>
                  <th>Borrower</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let loan of loans">
                  <td style="max-width: 200px;">
                    <strong>{{ loan.book?.title || 'Unknown Book' }}</strong>
                  </td>
                  <td>{{ loan.lender?.username || 'Unknown' }}</td>
                  <td>{{ loan.borrower?.username || 'Unknown' }}</td>
                  <td>{{ formatDate(loan.startDate) }}</td>
                  <td>{{ formatDate(loan.endDate) }}</td>
                  <td>
                    <span class="badge" [ngClass]="getStatusBadgeClass(loan.status)">
                      {{ loan.status }}
                    </span>
                  </td>
                  <td style="min-width: 100px;">
                    <div class="d-grid gap-1">
                      <button type="button" class="btn btn-outline-primary btn-sm" (click)="openEditModal(loan)" title="Edit">
                        <i class="bi bi-pencil me-1"></i>Edit
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-sm" (click)="openDeleteModal(loan)" title="Delete">
                        <i class="bi bi-trash me-1"></i>Delete
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- No loans message -->
            <div *ngIf="loans.length === 0" class="text-center p-4">
              <i class="bi bi-journal-check display-1 text-muted"></i>
              <p class="text-muted mt-2">No loans found. Create your first loan!</p>
            </div>
          </div>

          <!-- Pagination -->
          <nav *ngIf="!loading && totalPages > 1" aria-label="Loans pagination">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 0">
                  <i class="bi bi-chevron-left"></i> Previous
                </button>
              </li>

              <li class="page-item"
                  *ngFor="let pageNum of getPageNumbers()"
                  [class.active]="pageNum === currentPage">
                <button class="page-link" (click)="goToPage(pageNum)">
                  {{ pageNum + 1 }}
                </button>
              </li>

              <li class="page-item" [class.disabled]="isLast">
                <button class="page-link" (click)="nextPage()" [disabled]="isLast">
                  Next <i class="bi bi-chevron-right"></i>
                </button>
              </li>
            </ul>
          </nav>

          <!-- Page info -->
          <div *ngIf="!loading && totalItems > 0" class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">
              Showing {{ (currentPage * pageSize) + 1 }} to {{ getEndIndex() }} of {{ totalItems }} loans
            </small>
            <small class="text-muted">
              Page {{ currentPage + 1 }} of {{ totalPages }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CREATE LOAN MODAL -->
<div class="modal" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Loan</h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>
      <div class="modal-body">
        <form #createForm="ngForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createLender" class="form-label">Lender *</label>
                <select class="form-select" id="createLender"
                        [(ngModel)]="loanForm.lenderId" name="lender"
                        (change)="onLenderChange()" required>
                  <option value="0">Select a lender</option>
                  <option *ngFor="let user of users" [value]="user.id">
                    {{ user.username }} ({{ user.email }})
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createBorrower" class="form-label">Borrower *</label>
                <select class="form-select" id="createBorrower"
                        [(ngModel)]="loanForm.borrowerId" name="borrower" required>
                  <option value="0">Select a borrower</option>
                  <option *ngFor="let user of users" [value]="user.id">
                    {{ user.username }} ({{ user.email }})
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createBook" class="form-label">Book *</label>
                <select class="form-select" id="createBook"
                        [(ngModel)]="loanForm.bookId" name="book" required
                        [disabled]="!loanForm.lenderId || loadingBooks">
                  <option value="0">{{ loadingBooks ? 'Loading books...' : 'Select a book' }}</option>
                  <option *ngFor="let book of availableBooks" [value]="book.id">
                    {{ book.title }}
                  </option>
                </select>
                <div class="form-text">Books available from the selected lender</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createStatus" class="form-label">Status *</label>
                <select class="form-select" id="createStatus"
                        [(ngModel)]="loanForm.status" name="status" required>
                  <option *ngFor="let status of loanStatuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createStartDate" class="form-label">Start Date *</label>
                <input type="date" class="form-control" id="createStartDate"
                       [(ngModel)]="loanForm.startDate" name="startDate" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="createEndDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="createEndDate"
                       [(ngModel)]="loanForm.endDate" name="endDate">
                <div class="form-text">Optional. Leave empty for open-ended loan</div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="createLoan()" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          Create Loan
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" [class.show]="showCreateModal" *ngIf="showCreateModal"></div>

<!-- EDIT LOAN MODAL -->
<div class="modal" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Loan</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form #editForm="ngForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editLender" class="form-label">Lender *</label>
                <select class="form-select" id="editLender"
                        [(ngModel)]="loanForm.lenderId" name="lender"
                        (change)="onLenderChange()" required>
                  <option value="0">Select a lender</option>
                  <option *ngFor="let user of users" [value]="user.id">
                    {{ user.username }} ({{ user.email }})
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editBorrower" class="form-label">Borrower *</label>
                <select class="form-select" id="editBorrower"
                        [(ngModel)]="loanForm.borrowerId" name="borrower" required>
                  <option value="0">Select a borrower</option>
                  <option *ngFor="let user of users" [value]="user.id">
                    {{ user.username }} ({{ user.email }})
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editBook" class="form-label">Book *</label>
                <select class="form-select" id="editBook"
                        [(ngModel)]="loanForm.bookId" name="book" required
                        [disabled]="!loanForm.lenderId || loadingBooks">
                  <option value="0">{{ loadingBooks ? 'Loading books...' : 'Select a book' }}</option>
                  <option *ngFor="let book of availableBooks" [value]="book.id">
                    {{ book.title }}
                  </option>
                </select>
                <div class="form-text">Books available from the selected lender</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editStatus" class="form-label">Status *</label>
                <select class="form-select" id="editStatus"
                        [(ngModel)]="loanForm.status" name="status" required>
                  <option *ngFor="let status of loanStatuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editStartDate" class="form-label">Start Date *</label>
                <input type="date" class="form-control" id="editStartDate"
                       [(ngModel)]="loanForm.startDate" name="startDate" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editEndDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="editEndDate"
                       [(ngModel)]="loanForm.endDate" name="endDate">
                <div class="form-text">Optional. Leave empty for open-ended loan</div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateLoan()" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          Update Loan
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" [class.show]="showEditModal" *ngIf="showEditModal"></div>

<!-- DELETE LOAN MODAL -->
<div class="modal" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Delete Loan</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this loan?</p>
        <div class="card" *ngIf="getSelectedLoan() as loan">
          <div class="card-body">
            <h6>Loan Details</h6>
            <p class="mb-1"><strong>Book:</strong> {{ loan.book?.title || 'Unknown Book' }}</p>
            <p class="mb-1"><strong>Lender:</strong> {{ loan.lender?.username || 'Unknown' }}</p>
            <p class="mb-1"><strong>Borrower:</strong> {{ loan.borrower?.username || 'Unknown' }}</p>
            <p class="mb-1"><strong>Status:</strong>
              <span class="badge" [ngClass]="getStatusBadgeClass(loan.status)">{{ loan.status }}</span>
            </p>
            <p class="mb-0"><strong>Period:</strong> {{ formatDate(loan.startDate) }} - {{ formatDate(loan.endDate) }}</p>
          </div>
        </div>
        <div class="alert alert-warning mt-3">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Warning:</strong> This action cannot be undone. All loan data will be permanently deleted.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deleteLoan()" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          Delete Loan
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" [class.show]="showDeleteModal" *ngIf="showDeleteModal"></div>
